# iOS BanyaLLM 메모리 사양 및 설정

## 타겟 디바이스: iPhone 16 Pro

### 하드웨어 사양
- **RAM**: 8GB
- **GPU**: Apple A18 Pro GPU
- **메모리 아키텍처**: Unified Memory (GPU와 시스템 RAM 공유)

## 현재 Llama 3.1 모델 설정

### 모델 정보
- **파라미터 수**: 8B (80억)
- **양자화**: Q4_K_M
- **모델 크기**: 약 4.6GB
- **레이어 수**: 32개
- **임베딩 차원**: 4096

### 컨텍스트 및 배치 설정
- **n_ctx (컨텍스트 윈도우)**: 2048 토큰
- **n_batch (배치 크기)**: 2048 토큰
- **n_gpu_layers**: 24개 (33개 중 24개를 GPU에 로드, 약 70%)
- **n_len (최대 생성 토큰)**: 256 토큰

## 메모리 사용량 분석

### 1. 모델 메모리
- **크기**: 약 4.6GB
- **위치**: 
  - GPU: 24개 레이어 (약 3.2GB)
  - CPU: 9개 레이어 (약 1.4GB)

### 2. KV Cache 메모리
KV Cache는 컨텍스트 윈도우 크기에 비례하여 메모리를 사용합니다.

**계산식:**
```
KV Cache 크기 = n_ctx × embedding_dim × 2 bytes (f16) × num_layers
```

**현재 설정 기준:**
- n_ctx: 2048
- embedding_dim: 4096
- num_layers: 32
- 데이터 타입: f16 (2 bytes)

**계산:**
```
KV Cache = 2048 × 4096 × 2 × 32
         = 536,870,912 bytes
         ≈ 512 MB
```

### 3. 배치 메모리
- 배치 크기: 2048 토큰
- 배치 메모리는 상대적으로 작음 (수십 MB 수준)

### 4. iOS 시스템 메모리
- iOS 시스템 및 다른 앱: 약 2-3GB

## 총 메모리 사용량 추정

| 항목 | 메모리 사용량 |
|------|--------------|
| 모델 (GPU + CPU) | ~4.6GB |
| KV Cache | ~512MB |
| 배치 메모리 | ~50MB |
| iOS 시스템 | ~2-3GB |
| **총계** | **약 7-8GB** |

## 메모리 여유도 평가

### 현재 설정 (n_ctx = 2048)
- **총 메모리 사용량**: 약 7-8GB
- **사용 가능한 RAM**: 8GB
- **여유 메모리**: 거의 없음 (0-1GB)
- **평가**: ⚠️ **여유가 적음** - 메모리 부족 가능성 있음

### 권장 사항

#### 1. 현재 설정 유지 (테스트 권장)
- 실제 테스트를 통해 메모리 사용량 모니터링
- 메모리 부족 발생 시 아래 옵션 고려

#### 2. 메모리 부족 시 조정 옵션

**옵션 A: 컨텍스트 윈도우 축소**
```swift
ctx_params.n_ctx = 1536  // 2048 → 1536 (25% 감소)
ctx_params.n_batch = 1536
```
- KV Cache: ~384MB (128MB 절약)
- 총 메모리: 약 6.9GB
- 여유: 약 1GB

**옵션 B: 더 보수적인 설정**
```swift
ctx_params.n_ctx = 1024  // 2048 → 1024 (50% 감소)
ctx_params.n_batch = 1024
```
- KV Cache: ~256MB (256MB 절약)
- 총 메모리: 약 6.5GB
- 여유: 약 1.5GB

**옵션 C: GPU 레이어 수 감소**
```swift
model_params.n_gpu_layers = 20  // 24 → 20
```
- CPU로 더 많은 레이어 처리
- GPU 메모리 부담 감소
- 처리 속도는 약간 느려질 수 있음

## 메모리 최적화 전략

### 1. 동적 메모리 관리
- 배치 사이즈 오류 발생 시 자동으로 컨텍스트 초기화
- 대화 히스토리 자동 삭제

### 2. 프롬프트 최적화
- 웹 검색 결과 크기 제한 (현재: 2개 결과, 각 50자)
- 이전 대화 맥락 제한 (최대 3턴)

### 3. 모니터링
- 메모리 사용량 실시간 모니터링
- 배치 사이즈 오류 발생 빈도 추적

## 참고사항

1. **Unified Memory**: iPhone의 GPU와 시스템 RAM은 공유 메모리를 사용하므로, GPU 메모리 사용량이 시스템 RAM에 직접 영향을 줍니다.

2. **메모리 압박**: iOS는 메모리 압박 상황에서 백그라운드 앱을 종료하거나 앱을 강제 종료할 수 있습니다.

3. **실제 사용량**: 위 계산은 이론적 추정치이며, 실제 메모리 사용량은 모델 구조, 양자화 방식, iOS 버전 등에 따라 달라질 수 있습니다.

4. **테스트 필요**: 실제 디바이스에서 메모리 사용량을 측정하여 정확한 값을 확인하는 것이 중요합니다.

## 결론

현재 설정(`n_ctx = 2048`, `n_batch = 2048`)은 iPhone 16 Pro의 8GB RAM으로 **동작 가능하지만 여유가 적습니다**. 

**권장 접근:**
1. 현재 설정으로 테스트 진행
2. 메모리 부족 발생 시 `n_ctx = 1536` 또는 `1024`로 조정
3. 지속적인 메모리 모니터링 및 최적화

